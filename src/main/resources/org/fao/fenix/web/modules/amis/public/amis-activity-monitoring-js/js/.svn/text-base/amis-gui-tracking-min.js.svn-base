window.AMISTrackingGUI||(window.AMISTrackingGUI={prefix:"amis-activity-monitoring-js/",list:"",codes:"",baseurlcodes:"",baseurlwds:"",datasource:"",lang:"en",valuesResults:"",theme:"",ganalyticspkfile:"",ganalyticsemail:"",ganalyticsprofilename:"",ganalyticsprofileId:"",init:function(){$("#container").load(AMISTrackingGUI.prefix+"tracking-ui.html",function(){AMISTrackingGUI.initUI()})},initUI:function(){AMISTrackingGUI.hideChartDivs();$("#analytics-time-chart-options").jqxButtonGroup({theme:AMISTrackingGUI.theme, mode:"radio"});$("#analytics-time-chart-options").jqxButtonGroup("setSelection",0);$("#analytics-time-chart-options").on("buttonclick",function(a){a=a.args.button[0].id;$("#analytics-time-chart").empty();var d=$("#displayActivitySummaryRadioButton").jqxRadioButton("checked"),c="",b="";d?(c=$("#activitiesList").jqxListBox("getCheckedItems"),b="Overview of Selected Activities"):(c=$("#membersList").jqxListBox("getCheckedItems"),b="Overview of Selected Registered Members");"day"==a?AMISTrackingGUI.buildDailyTimeseries(c, "Daily "+b,d):"month"==a&&(b="Monthly "+b,AMISTrackingGUI.buildMonthlyTimeseries(c,b,d))});$("#membersList").jqxListBox({checkboxes:!0,width:280,height:230,theme:AMISTrackingGUI.theme});$("#selectAllMembersButton").jqxButton({width:"85px",height:"20px",theme:AMISTrackingGUI.theme});$("#selectAllMembersButton").bind("click",function(){$("#membersList").jqxListBox("checkAll")});$("#clearAllMembersButton").jqxButton({width:"140px",height:"20px",theme:AMISTrackingGUI.theme});$("#clearAllMembersButton").bind("click", function(){$("#membersList").jqxListBox("uncheckAll")});$("#activitiesList").jqxListBox({checkboxes:!0,width:280,height:90,theme:AMISTrackingGUI.theme});$("#selectAllActivitiesButton").jqxButton({width:"85px",height:"20px",theme:AMISTrackingGUI.theme});$("#selectAllActivitiesButton").bind("click",function(){$("#activitiesList").jqxListBox("checkAll")});$("#clearAllActivitiesButton").jqxButton({width:"140px",height:"20px",theme:AMISTrackingGUI.theme});$("#clearAllActivitiesButton").bind("click",function(){$("#activitiesList").jqxListBox("uncheckAll")}); $("#displayActivitySummaryRadioButton").jqxRadioButton({width:230,height:25,checked:!0});$("#displayActivitySummaryRadioButton").bind("change",function(a){a.args.checked?($("#membersLabel").hide(),$("#membersList").hide(),$("#selectAllMembersButton").hide(),$("#clearAllMembersButton").hide()):($("#membersLabel").show(),$("#membersList").show(),$("#selectAllMembersButton").show(),$("#clearAllMembersButton").show())});$("#displayActivitySummaryRadioButton").jqxRadioButton("checked")&&($("#membersLabel").hide(), $("#membersList").hide(),$("#selectAllMembersButton").hide(),$("#clearAllMembersButton").hide());$("#displayCountrySummaryRadioButton").jqxRadioButton({width:200,height:25});$("#displayCountrySummaryRadioButton").bind("change",function(a){a.args.checked?($("#activitiesLabel").hide(),$("#activitiesList").hide(),$("#selectAllActivitiesButton").hide(),$("#clearAllActivitiesButton").hide()):($("#activitiesLabel").show(),$("#activitiesList").show(),$("#selectAllActivitiesButton").show(),$("#clearAllActivitiesButton").show())}); $("#startDate").jqxDateTimeInput({width:"150px",height:"25px",theme:AMISTrackingGUI.theme,formatString:"yyyy-MM-dd",value:$.jqx._jqxDateTimeInput.getDateTime(new Date(2013,0,1))});$("#startDate").jqxDateTimeInput("setMinDate",new Date(2013,0,1));$("#startDate").jqxDateTimeInput("setValue",new Date(2013,0,1));$("#endDate").jqxDateTimeInput({width:"150px",height:"25px",theme:AMISTrackingGUI.theme,formatString:"yyyy-MM-dd"});$("#endDate").jqxDateTimeInput("setMaxDate",new Date);$("#submitButton").jqxButton({width:"150px", height:"25px",theme:AMISTrackingGUI.theme});$("#submitButton").bind("click",function(){$("#analytics-bar-chart").empty();if(""!=AMISTrackingGUI.ganalyticspkfile&&""!=AMISTrackingGUI.ganalyticsemail&&""!=AMISTrackingGUI.ganalyticsprofileId){var a=$("#displayActivitySummaryRadioButton").jqxRadioButton("checked"),d=$("#displayCountrySummaryRadioButton").jqxRadioButton("checked"),c=SubmitValidateParameters(a,d);null!=c?alert(c):a?(a=QueryBuilderTop5MembersQuery(),$.when(SubmitGetAnalyticsDataForQuery(AMISTrackingGUI, a)).done(function(b){if(null==b||"undefined"==typeof b.dataRows)console.log(" buildBarChart data response IS NULL -----------------------"+b);else{for(var a=[],d=0;d<b.dataRows.length;d++)a[d]=b.dataRows[d][0];a=AMISTrackingGUI.eliminateDuplicates(a);b=ChartBuilderProcessData(b.dataRows);ChartBuilderGetChart(b,a,"Overview of Selected Activities for Registered Members");b=$("#activitiesList").jqxListBox("getCheckedItems");AMISTrackingGUI.buildDailyTimeseries(b,"Daily Overview of Selected Activities", !0)}})):d&&(a=QueryBuilderTopActivitiesQuery(),$.when(SubmitGetAnalyticsDataForQuery(AMISTrackingGUI,a)).done(function(b){if(null==b)console.log(" buildBarChart data response IS NULL -----------------------"+b);else{b=b.dataRows;for(var a=[],d=0;d<b.length;d++)a[d]=b[d][0];a=AMISTrackingGUI.eliminateDuplicates(a);b=ChartBuilderProcessData(b);ChartBuilderGetChart(b,a,"Overview of Selected Registered Members Activities");b=$("#membersList").jqxListBox("getCheckedItems");AMISTrackingGUI.buildDailyTimeseries(b, "Daily Overview of Selected Registered Members",!1)}}))}else""==AMISTrackingGUI.ganalyticspkfile||""==AMISTrackingGUI.ganalyticsemail?alert("Please check that there is an authenticated Private Key File and Service Account Email."):""==AMISTrackingGUI.ganalyticsprofileId&&alert("The Analytics Profile Id is missing, so cannot proceed.")});AMISTrackingGUI.populateMembers();AMISTrackingGUI.populateActivities();AMISTrackingGUI.authenticateGoogleAnalytics()},populateMembers:function(){$.getJSON(AMISTrackingGUI.prefix+ "config/amis-members.json",function(a){$("#membersList").jqxListBox({source:a})})},populateActivities:function(){$.getJSON(AMISTrackingGUI.prefix+"config/amis-activities.json",function(a){$("#activitiesList").jqxListBox({source:a,displayMember:"label",valueMember:"code"})})},authenticateGoogleAnalytics:function(){$.getJSON(AMISTrackingGUI.prefix+"config/amis-google-analytics-configuration.json",function(a){var d=base64.encode(a.googleAnalyticsServiceAccountEmail),c=base64.encode(a.pkFileName);AMISTrackingGUI.ganalyticsprofilename= a.profile;$.ajax({type:"GET",url:"http://fenixapps.fao.org/google-analytics/rest/accounts/authenticate",data:{filename:c,email:d},dataType:"json",success:function(b){AMISTrackingGUI.ganalyticspkfile=b.encodedPrivateKeyFile;AMISTrackingGUI.ganalyticsemail=b.googleAnalyticsServiceAccountEmail;AMISTrackingGUI.getAccountsAndSetProfileId()},error:function(b){alert("ERROR in Authentication "+b.status)}})}).success(function(){console.log(" authentication success ")}).error(function(a,d){console.log("authentication error "+ d);console.log("authentication error incoming Text "+a.responseText)}).complete(function(){console.log(" authentication completed")})},getAccountsAndSetProfileId:function(){""!=AMISTrackingGUI.ganalyticspkfile&&""!=AMISTrackingGUI.ganalyticsemail?$.ajax({type:"GET",url:"http://fenixapps.fao.org/google-analytics/rest/accounts",data:{EncodedPKFile:AMISTrackingGUI.ganalyticspkfile,serviceAccountEmail:AMISTrackingGUI.ganalyticsemail},dataType:"json",success:function(a){for(var d=0;d<a.length;d++)for(var c= a[d].profilesList,b=0;b<c.length;b++)c[b].profileName==AMISTrackingGUI.ganalyticsprofilename&&(AMISTrackingGUI.ganalyticsprofileId=c[b].profileId)},error:function(a){alert("ERROR Accounts "+a.status)}}):console.log("populate ... parameters are empty")},eliminateDuplicates:function(a){var d,c=a.length,b=[],g={};for(d=0;d<c;d++)g[a[d]]=0;for(d in g)b.push(d);return b},testFunction:function(){$.getJSON("config/amis-google-analytics-configuration.json",function(a){var d=base64.encode(a.googleAnalyticsServiceAccountEmail); a=base64.encode(a.pkFileName);$.ajax({type:"GET",url:"http://localhost:8080/google-analytics/rest/accounts/authenticate",data:{filename:a,email:d},dataType:"json",success:function(a){var b=a.encodedPrivateKeyFile,d=a.googleAnalyticsServiceAccountEmail;$.ajax({type:"GET",url:"http://localhost:8080/google-analytics/rest/accounts",data:{EncodedPKFile:b,serviceAccountEmail:d},dataType:"json",success:function(){$.ajax({type:"GET",url:"http://localhost:8080/google-analytics/rest/accounts/27957799/webproperties/UA-27957799-1/profiles", data:{EncodedPKFile:b,serviceAccountEmail:d},dataType:"json",success:function(){},error:function(a){alert("ERROR Profiles "+a.status)}})},error:function(a){alert("ERROR Accounts "+a.status)}})},error:function(a){alert("ERROR Authenticate "+a.status)}})})},hideChartDivs:function(){$("#analytics-bar-chart-top-panel").hide();$("#analytics-bar-chart").hide();$("#analytics-time-chart-top-panel").hide();$("#analytics-time-chart").hide()},timeseriesOptionsOnClickAction:function(a){a=a.args.button[0].id; $("#analytics-time-chart").empty();var d=$("#displayActivitySummaryRadioButton").jqxRadioButton("checked"),c="",b="";d?(c=$("#activitiesList").jqxListBox("getCheckedItems"),b="Overview of Selected Activities"):(c=$("#membersList").jqxListBox("getCheckedItems"),b="Overview of Selected Registered Members");"day"==a?AMISTrackingGUI.buildDailyTimeseries(c,"Daily "+b,d):"month"==a&&(b="Monthly "+b,AMISTrackingGUI.buildMonthlyTimeseries(c,b,d))},buildDailyTimeseries:function(a,d,c){var b=new Map,g=[];$.each(a, function(){var e="",h=this.value,e=this.label,e=c?QueryBuilderMembersTimeseriesQuery(h,e,"day"):QueryBuilderActivitiesTimeseriesQuery(h,"day");$.when(SubmitGetAnalyticsDataForQuery(AMISTrackingGUI,e)).done(function(f){if(null==f)console.log(" buildDailyTimeseries data response IS NULL -----------------------"+f);else{f=f.dataRows;for(var c=0;c<f.length;c++)g[c]=f[c][0]+f[c][1];f=ChartBuilderProcessTimeSeriesValues(f);b.put(h,f)}b.size==a.length&&(f=AMISTrackingGUI.eliminateDuplicates(g),f=DateUtilsFormatDailyDates(f), ChartBuilderGetTimeseriesChart(b,f,d))})})},buildMonthlyTimeseries:function(a,d,c){var b=new Map,g=[];$.each(a,function(){var e="",h=this.value,e=this.label,e=c?QueryBuilderMembersTimeseriesQuery(h,e,"month"):QueryBuilderActivitiesTimeseriesQuery(h,"month");$.when(SubmitGetAnalyticsDataForQuery(AMISTrackingGUI,e)).done(function(c){if(null==c)console.log(" buildMonthlyTimeseries data response IS NULL -----------------------"+c);else{c=c.dataRows;for(var e=0;e<c.length;e++)g[e]=c[e][0]+c[e][1];c=ChartBuilderProcessMonthlyTimeSeriesValues(c); b.put(h,c)}b.size==a.length&&(c=AMISTrackingGUI.eliminateDuplicates(g),c=DateUtilsFormatMonthlyDates(c),ChartBuilderGetTimeseriesChart(b,c,d))})})}});